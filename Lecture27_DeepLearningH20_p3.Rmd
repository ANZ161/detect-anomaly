---
title: "Lecture 27 - Into Deep Learning P3"
output:
  html_document: default
  html_notebook: default
  pdf_document: default
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook


### Lecture 27 - Your project. Deep Learning with H2O. P.2 Implement Deep Learning Model to ShinyApp

Deep Learning... This lecture is dedicated to the implementation of Deep Learning models into for our Data

#### Work overview (from previous lecture)

* re-arranging data as matrix - DONE
* fitting deep learning models - DONE
* testing the models - DONE
* saving models - DONE
* implementation in our ShinyApp...

Finally we have our Deep Learning Model stored in the www folder:

```{r}
#files with model
file.info("www/tmp/normality_model.bin/DeepLearning_model_R_1510476990600_1")
```

Goal of this lecture will be to see how to use this model in R and ShinyApp to output results to the users

From: (R h2o load a saved model from disk in MOJO or POJO format)[https://stackoverflow.com/questions/45335697/r-h2o-load-a-saved-model-from-disk-in-mojo-or-pojo-format]

#### Using Binary Model to make predictions

```{r, message=FALSE, warning=FALSE}
library(h2o)
library(tidyverse)
library(plotly)
```

We have previously saved our model 

```{r}
# initialize h2o
h2o.init()
# load model
normality_model <- h2o.loadModel("www/tmp/normality_model.bin/DeepLearning_model_R_1510476990600_1") 
#and make predictions using 
# predict(model, test).
```



```{r}

# ============= READ DATA =================
# Read our small data ... 
DF_Data_Recent <- readRDS("DF_Data_Process_Recent.data") 

DF_Equipm <- read_csv("DF_EquipmData.csv")
# data frame containing Event Names
DF_EvCode <- read_csv("DF_EvCodeDataProject.csv")

# Data manipulation and saving to the DF_TEMP
DF_TEMP <- DF_Data_Recent %>% 
  # join to decode equipment serial number
  inner_join(DF_Equipm, by = "IDEquipment") %>% 
  # join to decode Event Code meaning
  inner_join(DF_EvCode, by = "EventCode") %>% 
  # select only column needed
  select(StartDate, Name, AnalogVal, EventText)
```

Then I will plot my data for all 4 machines as just to remember how it looks like...

```{r}
# creating human readable data and visualize them
DF_TEMP %>% 
  filter(EventText == "Tubing Process, resistance Ohm") %>% 
  ggplot(aes(x = StartDate, y = AnalogVal, col = Name)) + geom_point()+facet_grid(~Name)
```

Looking on the chart above I can see that machine #1 seems to be the best. I will take that one as a reference to build my Deep Learning Model. I will be extracting this dataset with a **filter()** function

```{r}
# extracting only one machine
DF_M1 <- DF_TEMP %>% 
  filter(EventText == "Tubing Process, resistance Ohm") %>% 
  filter(Name == "Machine #3") %>% 
  select(StartDate, AnalogVal) %>% 
  head(50)
```

#### Transposing the data

Now we need to **transpose** our data from long to wide structure! We will 'forget' the StartDate values and simply parse the values into matrix of dimension say 150 columns and 20 rows... Of course one need to recover some basic R skills for that :) if not use stackoverflow... (How to turn a vector into a matrix in R?)[https://stackoverflow.com/questions/14614946/how-to-turn-a-vector-into-a-matrix-in-r]

```{r}
DF_M1 <- DF_TEMP %>% 
  filter(EventText == "Tubing Process, resistance Ohm") %>% 
  filter(Name == "Machine #1") %>% 
  select(AnalogVal) %>% 
  t() %>%  # this brings us a matrix
  as.vector() %>% # let's make it a vector
  head(3000) %>% # only making fixed amount of rows
  matrix(nrow = 20, ncol = 150) # transforming that into matrix size 25x200
```

Wonderful, let's try to see! our new object as an image!!!

#### Explore the matrix as a surface!

Let's use `plotly` 3D graph to explore what we have got!

```{r, eval=FALSE, include=TRUE}
library(plotly)
plot_ly(z = DF_M1, type = "surface")

```

![Values from Machine 1 used for Training][id1]



This should be good enough to fit our deep learning model, but before we will do so I will 'prepare' my test datasets

A. For machine 2:

```{r}
DF_M2 <- DF_TEMP %>% 
  filter(EventText == "Tubing Process, resistance Ohm") %>% 
  filter(Name == "Machine #2") %>% 
  select(AnalogVal) %>% 
  t() %>%  # this brings us a matrix
  as.vector() %>% # let's make it a vector
  head(1500) %>% # only making fixed amount of rows
  matrix(nrow = 10, ncol = 150) # transforming that into matrix size 25x200
```

B. For machine 3:

```{r}
DF_M3 <- DF_TEMP %>% 
  filter(EventText == "Tubing Process, resistance Ohm") %>% 
  filter(Name == "Machine #3") %>% 
  select(AnalogVal) %>% 
  t() %>%  # this brings us a matrix
  as.vector() %>% # let's make it a vector
  head(3000) %>% # only making fixed amount of rows
  matrix(nrow = 20, ncol = 150) # transforming that into matrix size 25x200
```

C. For machine 4:

```{r}
DF_M4 <- DF_TEMP %>% 
  filter(EventText == "Tubing Process, resistance Ohm") %>% 
  filter(Name == "Machine #4") %>% 
  select(AnalogVal) %>% 
  t() %>%  # this brings us a matrix
  as.vector() %>% # let's make it a vector
  head(2850) %>% # only making fixed amount of rows
  matrix(nrow = 19, ncol = 150) # transforming that into matrix size 25x200
```

And we can also visualize that to confront:

For Machine 2

```{r, eval=FALSE, include=TRUE}
plot_ly(z = DF_M2, type = "surface")
```

![Values from Machine 2 used for Test][id2]

For Machine 3

```{r, eval=FALSE, include=TRUE}
plot_ly(z = DF_M3, type = "surface")
```

![Values from Machine 3 used for Test][id3]

For Machine 4

```{r, eval=FALSE, include=TRUE}
plot_ly(z = DF_M4, type = "surface")
```

![Values from Machine 4 used for Test][id4]

#### Fitting the Deep Learning Model

Launch the machine again...

```{r, eval=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# to load the library
library(h2o)

# to initialize the 'machine'
localH2O = h2o.init()
```

#### Load datasets to H2O

Then we will download the datasets into h2o. Remember H2O is just operated from R but it's a computer besides!


```{r, eval=TRUE, include=TRUE}
# Import train data into the H2O cluster
train_M1 <- as.h2o(x = DF_M1, destination_frame = "train_M1")

# Also import our test datasets for Machines 2 and 3...
test_M2  <- as.h2o(x = DF_M2, destination_frame = "test_M2")
test_M3  <- as.h2o(x = DF_M3, destination_frame = "test_M3")

# Make your own research usign DF_M4!

```


#### Building Deep Learning model with autoencoder

Now, once we know how our data looks like we can start to do our Anomaly Model

```{r, eval=TRUE, include=TRUE}

# Train deep autoencoder learning model on "normal" 
# training data, y ignored 
normality_model <- h2o.deeplearning(
 x = names(train_M1), 
 training_frame = train_M1, 
 activation = "Tanh", 
 autoencoder = TRUE, 
 hidden = c(50,20,50), 
 sparse = TRUE,
 l1 = 1e-4, 
 epochs = 100)
```

#### Calculate MSE from the train dataset

Let's use this model on our training dataset...

```{r, eval=TRUE, include=TRUE}
# computer error of the model
h2o.anomaly(normality_model, train_M1) %>% as.data.frame() %>% plot.ts(ylim = c(0, 2))
```

#### Getting to know what AI see:

```{r, eval=TRUE, include=TRUE}
# visually see it
test_recon_M1 <- h2o.predict(normality_model, train_M1) %>% as.matrix()
```

```{r, eval=FALSE, include=TRUE}
plot_ly(z = test_recon_M1, type = "surface")
```

![Predicted on Train Dataset][id5]

#### Detect Anomaly using MSE value

Now we will try to use test datasets from **machine 2**

```{r, eval=TRUE, include=TRUE}
# Compute reconstruction error with the Anomaly 
# detection app (MSE between output and input layers)
h2o.anomaly(normality_model, test_M2) %>%  as.data.frame() %>% plot.ts(ylim = c(0, 10), type = "p")
```

And for **machine 3**

```{r, eval=TRUE, include=TRUE}
h2o.anomaly(normality_model, test_M3) %>%  as.data.frame() %>% plot.ts(ylim = c(0, 10), type = "p")
```

It is now telling us that behaviour of Machine 2 is much different from machine 1. And on Machine 3 we have a clearly peaks that are distinguishable to recover anomaly!

**Note:** You may try to practice with Machine 4!


#### Use Anomaly model to reconstruct Test Dataset

Now we can obtain predictions, or physical values using our model. We should provide the model and test dataset

```{r, eval=TRUE, include=TRUE}
# Note: Testing = Reconstructing the test dataset
test_recon_M3 <- h2o.predict(normality_model, test_M3) %>% as.matrix()
plot_ly(z = test_recon_M3, type = "surface")
```

we can not definitely see those peaks as clear now however let us be satisfied with the model result and think how to implement our Deep Learning Model in ShinyApp


#### Saving Deep Learning Model for the future use

To use our model in our ShinyApp we will save it...

```{r, eval=FALSE, include=TRUE}

if(!file.exists("www/tmp/normality_model.bin")){
h2o.saveModel(normality_model, "www/tmp/normality_model.bin")
h2o.download_pojo(normality_model, "www/tmp", get_jar = TRUE)
}
```

And let's not forget to switch off our cluster!
```{r, eval=TRUE, include=TRUE}
h2o.shutdown(prompt= FALSE)

```

#### Conclusion

In this example the Anomaly Detection model was able to output the anomaly in rows 21-23. 

It learned on the pattern of many vectors and was able to distinguish the anomaly coming on new dataset

Practical use of this model can be to us function **h2o.anomaly**. In case the MSE value will be high - the anomaly is detected!

#### Next step

our next step will be to repeat the procedure but on our machine data. 

* re-arranging data as matrix
* fitting deep learning models
* testing the models
* saving models
* implementation in our ShinyApp...

#### used references

example from: (https://dzone.com/articles/anomaly-detection-with-deep-learning-in-r-with-h2o)[https://dzone.com/articles/anomaly-detection-with-deep-learning-in-r-with-h2o]

More reading: (https://dzone.com/articles/the-basics-of-deep-learning-how-to-apply-it-to-pre?fromrel=true)[https://dzone.com/articles/the-basics-of-deep-learning-how-to-apply-it-to-pre?fromrel=true]

And: (https://shiring.github.io/machine_learning/2017/05/01/fraud)[https://shiring.github.io/machine_learning/2017/05/01/fraud]

paper: (https://arxiv.org/abs/1701.01887)[https://arxiv.org/abs/1701.01887]
In this lecture we would explore the 'technology' on the sample and try to do this in 10 min lecture!

At the bottom of the document:

[id1]: plots/M1_train.png "Data used to Train the model"
[id2]: plots/M2_test.png "Data used to Test the model - Machine 2"
[id3]: plots/M3_test.png "Data used to Test the model - Machine 3"
[id4]: plots/M4_test.png "Data used to Test the model - Machine 4"
[id5]: plots/M1_pred.png "What AI see on Train Data"



