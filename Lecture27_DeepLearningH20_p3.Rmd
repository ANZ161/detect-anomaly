---
title: "Lecture 27 - Into Deep Learning P3"
output:
  html_document: default
  html_notebook: default
  pdf_document: default
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook


### Lecture 27 - Your project. Deep Learning with H2O. P.2 Implement Deep Learning Model to ShinyApp

Deep Learning... This lecture is dedicated to the implementation of Deep Learning models into for our Data

#### Work overview (from previous lectures)

* re-arranging data as matrix - DONE
* fitting deep learning models - DONE
* testing the models - DONE
* saving models - DONE
* implementation in our ShinyApp... - to be covered in this lecture

In order to achieve this goal we will have to perform some steps:

1. Learn how to use saved model in R to make predictions
2. Develop and implement app usage strategy
3. Return to our time series to identify time of anomaly

#### Using saved h2o model in R

In the prevous lecture we have saved our Deep Learning Model in the www folder:

```{r}
#files with model
file.info("www/tmp/normality_model.bin/DeepLearning_model_R_1510476990600_1")
```
One of the Goals of this lecture will be to see how to use this model in R to make predictions

From: (R h2o load a saved model from disk in MOJO or POJO format)[https://stackoverflow.com/questions/45335697/r-h2o-load-a-saved-model-from-disk-in-mojo-or-pojo-format]

We know that two types of strategy are possible

1. use a binary model 
2. export a model to MOJO (or POJO) form


#### Using Binary Model to make predictions

```{r, message=FALSE, warning=FALSE}
library(h2o)
library(tidyverse)
library(plotly)
```

Initializing H2O and loading the model

```{r, eval=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# initialize h2o
h2o.init()
# load model
normality_model <- h2o.loadModel("www/tmp/normality_model.bin/DeepLearning_model_R_1510476990600_1") 
```

We will also need to quickly construct the dataset we can predict the result

```{r, message=FALSE, warning=FALSE}

# ============= READ DATA =================
# Read our small data ... 
DF_Data_Recent <- readRDS("DF_Data_Process_Recent.data") 

DF_Equipm <- read_csv("DF_EquipmData.csv")
# data frame containing Event Names
DF_EvCode <- read_csv("DF_EvCodeDataProject.csv")

# Data manipulation and saving to the DF_TEMP
DF_TEMP <- DF_Data_Recent %>% 
  # join to decode equipment serial number
  inner_join(DF_Equipm, by = "IDEquipment") %>% 
  # join to decode Event Code meaning
  inner_join(DF_EvCode, by = "EventCode") %>% 
  # select only column needed
  select(StartDate, Name, AnalogVal, EventText)
```


Will be using Machine #4 for that

```{r}
# extracting only one machine
DF_M4 <- DF_TEMP %>% 
  filter(EventText == "Tubing Process, resistance Ohm") %>% 
  filter(Name == "Machine #4") %>% 
  arrange(StartDate) %>% 
  select(AnalogVal) %>% 
  t() %>%  # this brings us a matrix
  as.vector() %>% # let's make it a vector
  head(2850) %>% # only making fixed amount of rows
  matrix(nrow = 19, ncol = 150) %>% # transforming that into matrix size 25x200
  t() # transpose matrix to be able to detect anomalies in one row of lenght 150
```

```{r}
#side note - understand convertion to matrix
DF_s <- DF_TEMP %>% 
  filter(EventText == "Tubing Process, resistance Ohm") %>% 
  filter(Name == "Machine #4") %>% 
  arrange(StartDate) %>% 
  select(AnalogVal) %>% 
  t() %>%  # this brings us a matrix
  as.vector() %>% # let's make it a vector
  head(30) %>% # only making fixed amount of rows
  matrix(nrow = 5, ncol = 6)

DF_s1 <- DF_TEMP %>% 
  filter(EventText == "Tubing Process, resistance Ohm") %>% 
  filter(Name == "Machine #4") %>% 
  arrange(StartDate) %>% 
  select(AnalogVal) %>% 
  t() %>%  # this brings us a matrix
  as.vector() %>% # let's make it a vector
  head(30) %>% # only making fixed amount of rows
  matrix(nrow = 5, ncol = 6) %>% 
  t()
```



Before prediction we can visualize what we have got

```{r, eval=FALSE, include=TRUE}
plot_ly(z = DF_M4, type = "surface")
```

#### Predicting anomaly on Machine 4

In order to predict on `DF_M4` dataset we need to make it H2OFrame class. We need to load this object into H2O environment

```{r}
# load dataset into H2O environment
test_M4  <- as.h2o(x = DF_M4, destination_frame = "test_M3")
```


```{r}
# plot the anomalies
h2o.anomaly(normality_model, test_M4) %>% as.data.frame() %>% plot.ts(type = "p")
```

This brings us to the point of identifying anomaly on rows 6, 7, 12, 14. But we need to think yet how to interpret these points for the user. So far these points have no meaning. Hence we shall return to original times and parameters of when the eventual anomaly/problem occurred.

For that I will return back and construct the same matrix with a references for the dates


```{r, eval=TRUE, include=TRUE}
# generating time-series matrix corresponding to anomalies
DF_M4_DT <- DF_TEMP %>% 
  filter(EventText == "Tubing Process, resistance Ohm") %>% 
  filter(Name == "Machine #4") %>% 
  arrange(StartDate) %>% 
  select(StartDate) %>% 
  t() %>%  # this brings us a matrix
  as.vector() %>% # let's make it a vector
  head(2850) %>% # only making fixed amount of rows
  matrix(nrow = 19, ncol = 150) # transforming that into matrix size 25x200
```

Now, another time we must go out of comfort zone. Time to construct our dataframe which will contain values identified as anomalous!

```{r}
# save MSE values
mse_out <- h2o.anomaly(normality_model, test_M4) %>% as.data.frame()
# filter anomalies
rows_anomals <- which(mse_out > 0.3)
rows_normals <- which(mse_out <= 0.3)
```

This brings us to the point where we have rows indices that were classified as anomaly and other rows that were not.

```{r}
# subset rows with matrices that shows the anomalies
matr_anomals <- DF_M4[rows_anomals, ]
matr_anomalT <- DF_M4_DT[rows_anomals, ] #corresponding time date index

# subset rows with matrices that does not show the anomalies
matr_normals <- DF_M4[rows_normals, ] 
matr_normalT <- DF_M4_DT[rows_normals, ] #corresponding time date index
```

Just out of curiosity I will plot the anomalies values as 3D plot

```{r, eval=FALSE, include=TRUE}
plot_ly(z = matr_anomals, type = "surface")
```

And alsow those without

```{r, eval=FALSE, include=TRUE}
plot_ly(z = matr_normals, type = "surface")
```

This is wonderful! High anomalous spikes were detected!

Final sprint - bring original dataframe with anomaly labels









#### Calculate MSE from the train dataset

Let's use this model on our training dataset...

```{r, eval=TRUE, include=TRUE}
# computer error of the model
h2o.anomaly(normality_model, train_M1) %>% as.data.frame() %>% plot.ts(ylim = c(0, 2))
```

#### Getting to know what AI see:

```{r, eval=TRUE, include=TRUE}
# visually see it
test_recon_M1 <- h2o.predict(normality_model, train_M1) %>% as.matrix()
```

```{r, eval=FALSE, include=TRUE}
plot_ly(z = test_recon_M1, type = "surface")
```

![Predicted on Train Dataset][id5]

#### Detect Anomaly using MSE value

Now we will try to use test datasets from **machine 2**

```{r, eval=TRUE, include=TRUE}
# Compute reconstruction error with the Anomaly 
# detection app (MSE between output and input layers)
h2o.anomaly(normality_model, test_M2) %>%  as.data.frame() %>% plot.ts(ylim = c(0, 10), type = "p")
```

And for **machine 3**

```{r, eval=TRUE, include=TRUE}
h2o.anomaly(normality_model, test_M3) %>%  as.data.frame() %>% plot.ts(ylim = c(0, 10), type = "p")
```

It is now telling us that behaviour of Machine 2 is much different from machine 1. And on Machine 3 we have a clearly peaks that are distinguishable to recover anomaly!

**Note:** You may try to practice with Machine 4!


#### Use Anomaly model to reconstruct Test Dataset

Now we can obtain predictions, or physical values using our model. We should provide the model and test dataset

```{r, eval=TRUE, include=TRUE}
# Note: Testing = Reconstructing the test dataset
test_recon_M3 <- h2o.predict(normality_model, test_M3) %>% as.matrix()
plot_ly(z = test_recon_M3, type = "surface")
```

we can not definitely see those peaks as clear now however let us be satisfied with the model result and think how to implement our Deep Learning Model in ShinyApp


#### Saving Deep Learning Model for the future use

To use our model in our ShinyApp we will save it...

```{r, eval=FALSE, include=TRUE}

if(!file.exists("www/tmp/normality_model.bin")){
h2o.saveModel(normality_model, "www/tmp/normality_model.bin")
h2o.download_pojo(normality_model, "www/tmp", get_jar = TRUE)
}
```

And let's not forget to switch off our cluster!
```{r, eval=TRUE, include=TRUE}
h2o.shutdown(prompt= FALSE)

```

#### Conclusion

In this example the Anomaly Detection model was able to output the anomaly in rows 21-23. 

It learned on the pattern of many vectors and was able to distinguish the anomaly coming on new dataset

Practical use of this model can be to us function **h2o.anomaly**. In case the MSE value will be high - the anomaly is detected!

#### Next step

our next step will be to repeat the procedure but on our machine data. 

* re-arranging data as matrix
* fitting deep learning models
* testing the models
* saving models
* implementation in our ShinyApp...

#### used references

example from: (https://dzone.com/articles/anomaly-detection-with-deep-learning-in-r-with-h2o)[https://dzone.com/articles/anomaly-detection-with-deep-learning-in-r-with-h2o]

More reading: (https://dzone.com/articles/the-basics-of-deep-learning-how-to-apply-it-to-pre?fromrel=true)[https://dzone.com/articles/the-basics-of-deep-learning-how-to-apply-it-to-pre?fromrel=true]

The phylosophy that was already explained in the course (I discovered that later...:) : (https://dzone.com/articles/dive-deep-into-deep-learning-using-h2o-1)[https://dzone.com/articles/dive-deep-into-deep-learning-using-h2o-1]

And: (https://shiring.github.io/machine_learning/2017/05/01/fraud)[https://shiring.github.io/machine_learning/2017/05/01/fraud]

paper: (https://arxiv.org/abs/1701.01887)[https://arxiv.org/abs/1701.01887]
In this lecture we would explore the 'technology' on the sample and try to do this in 10 min lecture!

At the bottom of the document:

[id1]: plots/M1_train.png "Data used to Train the model"
[id2]: plots/M2_test.png "Data used to Test the model - Machine 2"
[id3]: plots/M3_test.png "Data used to Test the model - Machine 3"
[id4]: plots/M4_test.png "Data used to Test the model - Machine 4"
[id5]: plots/M1_pred.png "What AI see on Train Data"



