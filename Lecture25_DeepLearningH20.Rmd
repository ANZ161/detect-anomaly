---
title: "Lecture 25 - Into Deep Learning"
output:
  html_document: default
  html_notebook: default
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook


### Lecture 25 - Your project. Deep Learning

Deep Learning... In this lecture I would like to esplore with you the DeepLearning we can do with H2O package in R...

#### Learning to do Deep Learning

Inspired from (https://dzone.com/articles/anomaly-detection-with-deep-learning-in-r-with-h2o)[https://dzone.com/articles/anomaly-detection-with-deep-learning-in-r-with-h2o]

Also used: (https://dzone.com/articles/the-basics-of-deep-learning-how-to-apply-it-to-pre?fromrel=true)[https://dzone.com/articles/the-basics-of-deep-learning-how-to-apply-it-to-pre?fromrel=true]

And: (https://shiring.github.io/machine_learning/2017/05/01/fraud)[https://shiring.github.io/machine_learning/2017/05/01/fraud]

In this lecture we would explore the 'technology' on the sample and try to do this in 10 min lecture!

##### Understanding architecture

The 'Thing' will be working on your computer. In fact you will install another 'computer' inside your 'computer'...

##### Installing from R and starting it up


These instructions I got from: (http://h2o.ai/download/)[http://h2o.ai/download/]. Simply use 'Install from R' option

```{r, eval=FALSE, include=TRUE}
# The following two commands will remove any previously installed H2O packages for R.
if ("package:h2o" %in% search()) { detach("package:h2o", unload=TRUE) }
if ("h2o" %in% rownames(installed.packages())) { remove.packages("h2o") }

# Next, we download packages that H2O depends on.
pkgs <- c("statmod","RCurl","jsonlite")
for (pkg in pkgs) {
if (! (pkg %in% rownames(installed.packages()))) { install.packages(pkg) }
}

# Now we download, install and initialize the H2O package for R.
install.packages("h2o", type="source", repos="http://h2o-release.s3.amazonaws.com/h2o/rel-weierstrass/7/R")

# Finally, let's load H2O and start up an H2O cluster
library(h2o)
h2o.init()
```

As you see this will actually start the 'cluster' on our machine! We will now can look on `Localhost:54321` to see the 'interface' of our cluster...

As a trial let's learn how to shut down the machine...

```{r, eval=FALSE, include=TRUE}
# we can shut down the 'machine' like this...
h2o.shutdown(prompt= FALSE)
```

# Explore the thing on 'example'

We will now run the demo from H2O. First thing we will launch the machine again...

```{r, eval=FALSE, include=TRUE}
# to load the library
library(h2o)

# to initialize the 'machine'
h2o.init()
```

Then we will download the datasets from h2o.

```{r, eval=FALSE, include=TRUE}
# Import ECG train and test data into the H2O cluster
train_ecg <- h2o.importFile(
 path = "http://h2o-public-test-data.s3.amazonaws.com/smalldata/anomaly/ecg_discord_train.csv", 
 header = FALSE, 
 sep = ",")
test_ecg <- h2o.importFile(
 path = "http://h2o-public-test-data.s3.amazonaws.com/smalldata/anomaly/ecg_discord_test.csv", 
 header = FALSE, 
 sep = ",")
```

Personally I like to know what is in the data and how it look like!!! I will just use this link and put it into the browser. This will download the files with raw data. If I open this dataset it would not tell me much! I will plot this data in excel...

**Train data set**
![Train Data][id1]

**Test data set**
![Test Data][id2]

Or, I can also pull the data from h2o with 

```{r, eval=FALSE, include=TRUE}
# data frame for training dataset
df_train <- as.data.frame(train_ecg)
# data frame for test dataset
df_test <- as.data.frame(test_ecg)
```

from there we can see that the difference between both are in the three new rows 21-23

Now, once we know how our data looks like we can start to do our Anomaly Model

```{r, eval=FALSE, include=TRUE}

# Train deep autoencoder learning model on "normal" 
# training data, y ignored 
anomaly_model <- h2o.deeplearning(
 x = names(train_ecg), 
 training_frame = train_ecg, 
 activation = "Tanh", 
 autoencoder = TRUE, 
 hidden = c(50,20,50), 
 sparse = TRUE,
 l1 = 1e-4, 
 epochs = 100)
```
Let's use this model on our training dataset...

```{r, eval=FALSE, include=TRUE}
# computer error of the model
mod_error <- h2o.anomaly(anomaly_model, train_ecg)
```

get it as a plot and see that the value is very low

```{r, eval=FALSE, include=TRUE}
# visually see it
library(tidyverse)
h2o.anomaly(anomaly_model, train_ecg) %>% 
  as.data.frame() %>% plot.ts(ylim = c(0, 2))
```


Once our model is made, we can use it to detect anomalies in our **test** dataset


```{r, eval=FALSE, include=TRUE}
# Compute reconstruction error with the Anomaly 
# detection app (MSE between output and input layers)
recon_error <- h2o.anomaly(anomaly_model, test_ecg)

# Pull reconstruction error data into R and 
# plot to find outliers (last 3 heartbeats)
df_recon_error <- as.data.frame(recon_error)
df_recon_error
```

We can plot this as well
```{r, eval=FALSE, include=TRUE}
plot.ts(df_recon_error)
```

What it is telling us is that based on the new data we have anomaly in elements 21, 22, 23

Now we can obtain predictions, or physical values using our model. We should provide the model and test dataset

```{r, eval=FALSE, include=TRUE}
# Note: Testing = Reconstructing the test dataset
test_recon <- h2o.predict(anomaly_model, test_ecg) 
```

```{r, eval=FALSE, include=TRUE}
head(test_recon)
```

In order to make things visible. Once again I ask excel to help... Here I simply write teh dataframe to csv and create graph in excel

```{r, eval=FALSE, include=TRUE}
# write to csv to use it in excel
test_recon %>% as.data.frame() %>% 
write.csv("test_predicted.csv")
```

**Predicted data set**
![Predicted Data][id3]

To use our model in our ShinyApp we will save it...

```{r, eval=FALSE, include=TRUE}
h2o.saveModel(anomaly_model, "C:/Users/fxtrams/Downloads/tmp/anomaly_model.bin")
h2o.download_pojo(anomaly_model, "C:/Users/fxtrams/Downloads/tmp", get_jar = TRUE)
```

And let's not forget to switch off our cluster!
```{r, eval=FALSE, include=TRUE}
h2o.shutdown(prompt= FALSE)

```

#### Conclusion

In this example the Anomaly Detection model was able to output the anomaly in rows 21-23. 

It learned on the pattern of many vectors and was able to distinguish the anomaly coming on new dataset

Practical use of this model can be to us function **h2o.anomaly**. In case the MSE value will be high - the anomaly is detected!

#### Next step

our next step will be to repeat the procedure but on our machine data. 

* arranging data to many vectors
* learning the models
* testing the models
* saving models

Once we can have our model ready next step will be implementation in our ShinyApp...

[id1]: train.PNG "Train"
[id2]: test.PNG "Test"
[id3]: predicted.PNG "Predicted"