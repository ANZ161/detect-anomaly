---
title: "Creating Anomaly Detection System for Industrial Process with Deep Learning"
output:
  html_document: default
  html_notebook: default
  pdf_document: default
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook


### Your project - Detect Anomaly in Industrial Process with Deep Learning

Deep Learning... In this lecture I would like to esplore with you the DeepLearning we can do with H2O package in R...

#### Data Exploration

```{r}
# libraries
library(tidyverse)
library(plotly)

# data reading
DF_NORMAL <- read_rds("DATA-normal.rds")
DF_TEST <- read_rds("DATA-test.rds")
DF_ANOMALY <- read_rds("DATA-anomaly.rds")

# names of the dataset columns
names(DF_NORMAL)
```

about the dataset

```{r}
NORM_2016 <- DF_NORMAL %>% select(2:11) %>% as.matrix() 
summary(NORM_2016)

```
This dataset was selected .. after .. the period of deep process maintenance

```{r}
plot_ly(z = NORM_2016, type = "surface")
```




```{r}




TEST_2015 <- DF_TEST %>% select(2:11) %>% as.matrix()
plot_ly(z = TEST_2015, type = "surface")

TEST_2017 <- DF_ANOMALY %>% select(2:11) %>% as.matrix()
plot_ly(z = TEST_2017, type = "surface")


```

```{r}
NORM_2016 <- DF_NORMAL %>% select(2:11) %>% as.matrix()



plot_ly(z = NORM_2016, type = "surface")

TEST_2015 <- DF_TEST %>% select(2:11) %>% as.matrix()
plot_ly(z = TEST_2015, type = "surface")

TEST_2017 <- DF_ANOMALY %>% select(2:11) %>% as.matrix()
plot_ly(z = TEST_2017, type = "surface")


```








#### Train Deep Learning Model DRAFT

```{r}
NORM_2016_sc <- DF_NORMAL %>% select(2:11) %>% scale() %>% as.matrix() 
```



```{r}
library(h2o)
h2o.init(nthreads = 2)
train_sc <- as.h2o(x = NORM_2016_sc, destination_frame = "trainsc")
train <- as.h2o(x = NORM_2016, destination_frame = "train")
test <- as.h2o(x = TEST_2015, destination_frame = "test")
anomaly <- as.h2o(x = TEST_2017, destination_frame = "anomaly")

normality_model <- h2o.deeplearning(x = names(train), 
                                     training_frame = train, 
                                     activation = "Tanh", 
                                     autoencoder = TRUE, 
                                     hidden = c(200,100,200), 
                                     sparse = TRUE,
                                     l1 = 1e-4, 
                                     epochs = 100)

normality_model_sc <- h2o.deeplearning(x = names(train_sc), 
                                     training_frame = train_sc, 
                                     activation = "Tanh", 
                                     autoencoder = TRUE, 
                                     hidden = c(200,100,200), 
                                     sparse = TRUE,
                                     l1 = 1e-4, 
                                     epochs = 100)

```

#### reconstruct dataset

```{r}
# recreate 
test_recon <- h2o.predict(normality_model, train) %>% as.matrix()
plot_ly(z = test_recon, type = "surface")
```

#### Check MSE


```{r}

mse <- h2o.anomaly(normality_model, train) %>% as.data.frame()
mse_sc <- h2o.anomaly(normality_model_sc, train_sc) %>% as.data.frame()
mse_test <- h2o.anomaly(normality_model, test) %>% as.data.frame()
mse_anom <- h2o.anomaly(normality_model, anomaly) %>% as.data.frame()

plot.ts(mse)
plot.ts(mse_sc)
plot.ts(mse_test)
plot.ts(mse_anom)


```

# shutdown JVM
```{r}
h2o.shutdown(prompt = F)
```

