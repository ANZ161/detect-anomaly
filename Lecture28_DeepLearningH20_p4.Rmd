---
title: "Lecture 28 - Into Deep Learning P4"
output:
  html_document: default
  html_notebook: default
  pdf_document: default
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook


### Lecture 28 - Your project. Deep Learning with H2O. P.4 Implement Deep Learning Model to ShinyApp

Deep Learning... This lecture is dedicated to the implementation of Deep Learning models into for our Data

#### Work overview (from previous lectures)

* Review App
* Reverse Engineer
* Recommendations
* Template to train NN models

#### Review the App

Open Scripts ui.R, server.R and global.R. Run the App...

#### Reverse Engineer

Follow the R scripts and below diagram to find elements of the ShinyApp

![Architecture][id1]

#### General Template to Train Models

This code contains a procedure to train Deep Learning models that will make Shiny App working.

This procedure will have to be repeated anytime when h2o source package is updated!

```{r, eval=FALSE, include=TRUE}
library(tidyverse)
library(plotly)
library(h2o)
# ============= READ DATA =================
# Read our small data ... 
DF_Data_Recent <- readRDS("DF_Data_Process_Recent.data") 

DF_Equipm <- read_csv("DF_EquipmData.csv")
# data frame containing Event Names
DF_EvCode <- read_csv("DF_EvCodeDataProject.csv")

# Data manipulation and saving to the DF_TEMP
DF_TEMP <- DF_Data_Recent %>% 
  # join to decode equipment serial number
  inner_join(DF_Equipm, by = "IDEquipment") %>% 
  # join to decode Event Code meaning
  inner_join(DF_EvCode, by = "EventCode") %>% 
  # select only column needed
  select(StartDate, Name, AnalogVal, EventText)


```

## Generate the model for one process

```{r, eval=FALSE, include=TRUE}
# Visualize
DF_TEMP %>% 
  filter(EventText == "Tubing Process, phase angle") %>% 
  ggplot(aes(x = StartDate, y = AnalogVal, col = Name)) + geom_point()+facet_grid(~Name)

# Choose best machine to train model - Machine 1 (Domain Knowldege), extract data
# "Tubing Process, Phase"
DF_TEMP_TPA <- DF_TEMP %>% 
  filter(EventText == "Tubing Process, phase angle") %>% 
  filter(Name == "Machine #1") %>% 
  select(StartDate, AnalogVal) %>% 
  arrange(StartDate)

# transform to 2 matrixes
source("to_m.R")
source("to_matrixDT.R")

DF_M1 <- to_m(DF_TEMP_TPA, 150)
#DF_M1t<- to_mDT(DF_TEMP_TPA, 150)

```

```{r, eval=FALSE, include=TRUE}
# to initialize the 'machine'
localH2O = h2o.init()

train_M1 <- as.h2o(x = DF_M1, destination_frame = "train_M1")

normality_model <- h2o.deeplearning(
 x = names(train_M1),
 model_id =  "Tubing Process, phase angle",
 training_frame = train_M1, 
 activation = "Tanh", 
 autoencoder = TRUE, 
 hidden = c(50,20,50), 
 sparse = TRUE,
 l1 = 1e-4, 
 epochs = 100)

# computer error of the model
h2o.anomaly(normality_model, train_M1) %>% as.data.frame() %>% plot.ts(ylim = c(0, 10), type = "p")

# save model
h2o.saveModel(normality_model, "www/tmp/normality_model.bin")

# shutdown
h2o.shutdown(prompt = F)
```

## Create function

For all of our processes we would need to generate separate models. It is obviously better to write a function to avoid copy/paste and mistakes:

```{r}
train_model <- function(x, event_text, machine_name, num_cols = 150){
  require(h2o)
  require(tidyverse)
  source("to_m.R")
  # x - dataframe containing prepared data with many events
  # x <- DF_TEMP
  # event_text <- "Tubing Process, phase angle"
  # machine_name <- "Machine #4"
  # num_cols <- 150
  # h2o.init()
  DF_TEMP_TPA <- x %>% 
  filter(EventText == event_text) %>% 
  filter(Name == machine_name) %>% 
  select(StartDate, AnalogVal) %>% 
  arrange(StartDate)
  
  DF_M1 <- to_m(DF_TEMP_TPA, num_cols) %>% as.data.frame()
  
  train_M1 <- as.h2o(x = DF_M1, destination_frame = "train_M1")
  
  # model id must not have any commas or alike!
  my_mod <- str_remove_all(event_text, ",") %>% str_remove_all(" ")
  
  normality_model <- h2o.deeplearning(
   x = names(train_M1),
   model_id =  my_mod,
   training_frame = train_M1, 
   activation = "Tanh", 
   autoencoder = TRUE, 
   hidden = c(50,20,50), 
   sparse = TRUE,
   l1 = 1e-4, 
   epochs = 50)
  
  # save model
  h2o.saveModel(normality_model, "www/tmp/normality_model.bin",force = T)
  
}
```

## Create many models using one function

```{r}
DF_TEMP %>% select(EventText) %>% unique()
```

Nota Bene!!! this code may run ~ 5-10 minutes!!!

```{r, eval=FALSE, include=TRUE}
# to initialize the 'machine'
h2o.init(nthreads = 2)

## -------------------
# 1. Process Tubing Process, phase angle
## -------------------
# Visualize
DF_TEMP %>% 
  filter(EventText == "Tubing Process, phase angle") %>% 
  ggplot(aes(x = StartDate, y = AnalogVal, col = Name)) + geom_point()+facet_grid(~Name)

# Train the model using defined function
train_model(x = DF_TEMP, event_text = "Tubing Process, phase angle",machine_name = "Machine #4")

## -------------------
# 2. Process Edging Process, resistance Ohm
## -------------------
# Visualize to choose the best machine (using Domain knowledge)
DF_TEMP %>% 
  filter(EventText == "Edging Process, resistance Ohm") %>% 
  ggplot(aes(x = StartDate, y = AnalogVal, col = Name)) + geom_point()+facet_grid(~Name)

# Train the model using defined function
train_model(x = DF_TEMP, event_text = "Edging Process, resistance Ohm",machine_name = "Machine #4")


## -------------------
# 3. Process Cutting Process, resistance Ohm
## -------------------
# Visualize to choose the best machine (using Domain knowledge)
DF_TEMP %>% 
  filter(EventText == "Cutting Process, resistance Ohm") %>% 
  ggplot(aes(x = StartDate, y = AnalogVal, col = Name)) + geom_point()+facet_grid(~Name)

# Train the model using defined function
train_model(x = DF_TEMP, event_text = "Cutting Process, resistance Ohm",machine_name = "Machine #4")

## -------------------
# 4. Process Edging Process, resistance Ohm
## -------------------
# Visualize to choose the best machine (using Domain knowledge)
DF_TEMP %>% 
  filter(EventText == "Tubing Process, resistance Ohm") %>% 
  ggplot(aes(x = StartDate, y = AnalogVal, col = Name)) + geom_point()+facet_grid(~Name)

# Train the model using defined function
train_model(x = DF_TEMP, event_text = "Tubing Process, resistance Ohm",machine_name = "Machine #1")

## -------------------
# 5. Process Edging Process, resistance Ohm
## -------------------
# Visualize to choose the best machine (using Domain knowledge)
DF_TEMP %>% 
  filter(EventText == "Cutting Process, phase angle") %>% 
  ggplot(aes(x = StartDate, y = AnalogVal, col = Name)) + geom_point()+facet_grid(~Name)

# Train the model using defined function 
train_model(x = DF_TEMP, event_text = "Cutting Process, phase angle",machine_name = "Machine #2")

## -------------------
# 6. Process Edging Process, phase angle
## -------------------
# Visualize to choose the best machine (using Domain knowledge)
DF_TEMP %>% 
  filter(EventText == "Edging Process, phase angle") %>% 
  ggplot(aes(x = StartDate, y = AnalogVal, col = Name)) + geom_point()+facet_grid(~Name)

# Train the model using defined function
train_model(x = DF_TEMP, event_text = "Edging Process, phase angle",machine_name = "Machine #4")


# shutdown
h2o.shutdown(prompt = F)
```


[id1]: Architecture.PNG "Defined App Aproach"

