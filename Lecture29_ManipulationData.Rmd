---
title: "Lecture 29 - Exploration of data"
output:
  html_document: default
  html_notebook: default
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook

### Lecture 29 - Exploring relationships in data

#### Further ideas

At this time we will try to perform some more data manipulations in order to explore more relationships. One possibility is to see how one engineering parameter e.g. Impedance is related to another e.g. phase.

#### Review of available data

We can read data stored in the file **DF_Data_Process.data**. This is `R` object serialized and stored as a file. This dataset contains more than 9 mln rows. 

```{r, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
# read data into R environment
# ============= READ DATA =================
# Read our big data first ... 9 mln rows...
DF_Data_Process_All <- readRDS("DF_Data_Process.data")
# Dimension of dataset
dim(DF_Data_Process_All)
```


```{r}
# Read our small data  ... 
DF_Data_Process_Recent <- readRDS("DF_Data_Process_Recent.data")
# Dimension of dataset
dim(DF_Data_Process_Recent)
```

#### Join and visualize the data

We can make some better overview of data starting from 'recent' dataset. We join this dataset to more human readable format...

```{r, message=FALSE, warning=FALSE}
library(tidyverse)
# ============= JOIN DATA =================
# data frame containing equipment information
DF_Equipm <- read_csv("DF_EquipmData.csv")
# data frame containing Event Names
DF_EvCode <- read_csv("DF_EvCodeDataProject.csv")

# Data manipulation and saving to the DF_TEMP
DF_TEMP <- DF_Data_Process_All %>% 
  # join to decode equipment serial number
  inner_join(DF_Equipm, by = "IDEquipment") %>% 
  # join to decode Event Code meaning
  inner_join(DF_EvCode, by = "EventCode") %>% 
  # select only column needed
  select(StartDate, Name, AnalogVal, EventText)
```

#### relationship Tubing Process

We can extract one parameter for machine 1

```{r}
Tub_P1 <- DF_TEMP %>% 
  filter(EventText == "Tubing Process, phase angle") %>% 
  filter(Name == "Machine #1") %>% 
  select(StartDate, AnalogVal)

Tub_R1  <- DF_TEMP %>% 
  filter(EventText == "Tubing Process, resistance Ohm") %>% 
  filter(Name == "Machine #1")%>% 
  select(StartDate, AnalogVal)

Tub_P2 <- DF_TEMP %>% 
  filter(EventText == "Tubing Process, phase angle") %>% 
  filter(Name == "Machine #2") %>% 
  select(StartDate, AnalogVal)

Tub_R2  <- DF_TEMP %>% 
  filter(EventText == "Tubing Process, resistance Ohm") %>% 
  filter(Name == "Machine #2")%>% 
  select(StartDate, AnalogVal)

Tub_P3 <- DF_TEMP %>% 
  filter(EventText == "Tubing Process, phase angle") %>% 
  filter(Name == "Machine #3") %>% 
  select(StartDate, AnalogVal)

Tub_R3  <- DF_TEMP %>% 
  filter(EventText == "Tubing Process, resistance Ohm") %>% 
  filter(Name == "Machine #3")%>% 
  select(StartDate, AnalogVal)

Tub_P4 <- DF_TEMP %>% 
  filter(EventText == "Tubing Process, phase angle") %>% 
  filter(Name == "Machine #4") %>% 
  select(StartDate, AnalogVal)

Tub_R4  <- DF_TEMP %>% 
  filter(EventText == "Tubing Process, resistance Ohm") %>% 
  filter(Name == "Machine #4")%>% 
  select(StartDate, AnalogVal)
```

Our goal will be to write a function that can join these data to be on x and y axis with corresponding index of time summarized as average by minute

```{r}
library(xts)
library(tidyverse)
## Turn this into function
# function to create new features from original feature...
feature_eng_ts <- function(x, funcToApply = c("mean", "min", "max", "sd")){
  #function will return new dataframe with new features
  #x = dataframe with columns to perform feature engineering, it must contain data from one specific category
  #tscolname = column name containing time series data
  #avcolname - column name contining data to perform manipulations
  #funcToApply - vector containing functions to apply data transformations
  # convert to xts object
  DF_M1_xts <- as.xts(x[ ,-1], order.by = as.POSIXct(x$StartDate))
  # aggregate by hour and create new features
  # convert periodicity from seconds to hours and apply some functions to create new features
  for(i in 1: length(funcToApply)){
    # apply functions and merge them  
    res <- period.apply(DF_M1_xts, endpoints(DF_M1_xts, "mins"), funcToApply[i])
    names(res) <- paste("AnalogVal_", funcToApply[i], sep = "")
    # merge new features together
    if(i == 1){
      DF_M1_newfeatures <- res
      } else {
        DF_M1_newfeatures <- merge(DF_M1_newfeatures, res)
        }
  }
  # return to the dataframe
  DF_M1_NF <- coredata(DF_M1_newfeatures) %>% as.data.frame(row.names = F)
  DF_M1_NF$StartDate <- index(DF_M1_newfeatures)
  # removing rows with missing data!!!
  DF_M1_NF <- na.omit(DF_M1_NF)
  # return result
  return(DF_M1_NF)
}

df_R1 <- feature_eng_ts(Tub_R1, "mean")
df_P1 <- feature_eng_ts(Tub_P1, "mean")
df_R2 <- feature_eng_ts(Tub_R2, "mean")
df_P2 <- feature_eng_ts(Tub_P2, "mean")
df_R3 <- feature_eng_ts(Tub_R3, "mean")
df_P3 <- feature_eng_ts(Tub_P3, "mean")
df_R4 <- feature_eng_ts(Tub_R4, "mean")
df_P4 <- feature_eng_ts(Tub_P4, "mean")

df_J1 <- inner_join(df_R1, df_P1, by = "StartDate") 
df_J1$Machine <- "Machine 1"
df_J2 <- inner_join(df_R2, df_P2, by = "StartDate")
df_J2$Machine <- "Machine 2"
df_J3 <- inner_join(df_R3, df_P3, by = "StartDate") 
df_J3$Machine <- "Machine 3"
df_J4 <- inner_join(df_R4, df_P4, by = "StartDate")
df_J4$Machine <- "Machine 4"


df_All <- bind_rows(df_J1, df_J2, df_J3, df_J4)

ggplot(df_All, aes(x = AnalogVal_mean.y, y = AnalogVal_mean.x, col = Machine, alpha = 0.6)) + geom_point()



```

Let's make the same data graph for cutting process

#### relationship Cutting Process - too tired for the for loop:)

We can extract one parameter for machine 1

```{r}
Cut_P1 <- DF_TEMP %>% 
  filter(EventText == "Cutting Process, phase angle") %>% 
  filter(Name == "Machine #1") %>% 
  select(StartDate, AnalogVal)

Cut_R1  <- DF_TEMP %>% 
  filter(EventText == "Cutting Process, resistance Ohm") %>% 
  filter(Name == "Machine #1")%>% 
  select(StartDate, AnalogVal)

Cut_P2 <- DF_TEMP %>% 
  filter(EventText == "Cutting Process, phase angle") %>% 
  filter(Name == "Machine #2") %>% 
  select(StartDate, AnalogVal)

Cut_R2  <- DF_TEMP %>% 
  filter(EventText == "Cutting Process, resistance Ohm") %>% 
  filter(Name == "Machine #2")%>% 
  select(StartDate, AnalogVal)

Cut_P3 <- DF_TEMP %>% 
  filter(EventText == "Cutting Process, phase angle") %>% 
  filter(Name == "Machine #3") %>% 
  select(StartDate, AnalogVal)

Cut_R3  <- DF_TEMP %>% 
  filter(EventText == "Cutting Process, resistance Ohm") %>% 
  filter(Name == "Machine #3")%>% 
  select(StartDate, AnalogVal)

Cut_P4 <- DF_TEMP %>% 
  filter(EventText == "Cutting Process, phase angle") %>% 
  filter(Name == "Machine #4") %>% 
  select(StartDate, AnalogVal)

Cut_R4  <- DF_TEMP %>% 
  filter(EventText == "Cutting Process, resistance Ohm") %>% 
  filter(Name == "Machine #4")%>% 
  select(StartDate, AnalogVal)

df_R1 <- feature_eng_ts(Cut_R1, "mean")
df_P1 <- feature_eng_ts(Cut_P1, "mean")
df_R2 <- feature_eng_ts(Cut_R2, "mean")
df_P2 <- feature_eng_ts(Cut_P2, "mean")
df_R3 <- feature_eng_ts(Cut_R3, "mean")
df_P3 <- feature_eng_ts(Cut_P3, "mean")
df_R4 <- feature_eng_ts(Cut_R4, "mean")
df_P4 <- feature_eng_ts(Cut_P4, "mean")

df_J1 <- inner_join(df_R1, df_P1, by = "StartDate") 
df_J1$Machine <- "Machine 1"
df_J2 <- inner_join(df_R2, df_P2, by = "StartDate")
df_J2$Machine <- "Machine 2"
df_J3 <- inner_join(df_R3, df_P3, by = "StartDate") 
df_J3$Machine <- "Machine 3"
df_J4 <- inner_join(df_R4, df_P4, by = "StartDate")
df_J4$Machine <- "Machine 4"


df_All_cut <- bind_rows(df_J1, df_J2, df_J3, df_J4)

ggplot(df_All_cut, aes(x = AnalogVal_mean.y, y = AnalogVal_mean.x, col = Machine)) + geom_point()



```

#### relationship Edging Process - too tired for the for loop:)

We can extract one parameter for machine 1

```{r}
Edg_P1 <- DF_TEMP %>% 
  filter(EventText == "Edging Process, phase angle") %>% 
  filter(Name == "Machine #1") %>% 
  select(StartDate, AnalogVal)

Edg_R1  <- DF_TEMP %>% 
  filter(EventText == "Edging Process, resistance Ohm") %>% 
  filter(Name == "Machine #1")%>% 
  select(StartDate, AnalogVal)

Edg_P2 <- DF_TEMP %>% 
  filter(EventText == "Edging Process, phase angle") %>% 
  filter(Name == "Machine #2") %>% 
  select(StartDate, AnalogVal)

Edg_R2  <- DF_TEMP %>% 
  filter(EventText == "Edging Process, resistance Ohm") %>% 
  filter(Name == "Machine #2")%>% 
  select(StartDate, AnalogVal)

Edg_P3 <- DF_TEMP %>% 
  filter(EventText == "Edging Process, phase angle") %>% 
  filter(Name == "Machine #3") %>% 
  select(StartDate, AnalogVal)

Edg_R3  <- DF_TEMP %>% 
  filter(EventText == "Edging Process, resistance Ohm") %>% 
  filter(Name == "Machine #3")%>% 
  select(StartDate, AnalogVal)

Edg_P4 <- DF_TEMP %>% 
  filter(EventText == "Edging Process, phase angle") %>% 
  filter(Name == "Machine #4") %>% 
  select(StartDate, AnalogVal)

Edg_R4  <- DF_TEMP %>% 
  filter(EventText == "Edging Process, resistance Ohm") %>% 
  filter(Name == "Machine #4")%>% 
  select(StartDate, AnalogVal)

df_R1 <- feature_eng_ts(Edg_R1, "mean")
df_P1 <- feature_eng_ts(Edg_P1, "mean")
df_R2 <- feature_eng_ts(Edg_R2, "mean")
df_P2 <- feature_eng_ts(Edg_P2, "mean")
df_R3 <- feature_eng_ts(Edg_R3, "mean")
df_P3 <- feature_eng_ts(Edg_P3, "mean")
df_R4 <- feature_eng_ts(Edg_R4, "mean")
df_P4 <- feature_eng_ts(Edg_P4, "mean")

df_J1 <- inner_join(df_R1, df_P1, by = "StartDate") 
df_J1$Machine <- "Machine 1"
df_J2 <- inner_join(df_R2, df_P2, by = "StartDate")
df_J2$Machine <- "Machine 2"
df_J3 <- inner_join(df_R3, df_P3, by = "StartDate") 
df_J3$Machine <- "Machine 3"
df_J4 <- inner_join(df_R4, df_P4, by = "StartDate")
df_J4$Machine <- "Machine 4"


df_All_edg <- bind_rows(df_J1, df_J2, df_J3, df_J4)

ggplot(df_All_edg, aes(x = AnalogVal_mean.y, y = AnalogVal_mean.x, col = Machine)) + geom_point() 

ggplot(df_All_edg, aes(x = StartDate, y = AnalogVal_mean.y, col = Machine))+geom_line()+
  facet_grid(~Machine)
ggplot(df_All_edg, aes(x = StartDate, y = AnalogVal_mean.x, col = Machine))+geom_line()+
  facet_grid(~Machine)

```

